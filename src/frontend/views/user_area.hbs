<section id="home" class="hero-section">
    <div class="container">
        <div class="col-12 col-lg-10 p-3 mx-auto text-center big-white-modal d-flex flex-column justify-content-center align-items-center">
            <h2>Welcome to your personal area</h2>
            <h4>
                Here you can manage your projects and your NFTs collections.
            </h4>

            <div class="my-projects row w-100 mt-5">
                <h2 class="mb-5">My projects</h2>
                {{#each user.projects}}
                    <h3 class="mb-3">{{ name }}</h3>
                    <div class="row project-container align-items-center">
                        {{#each nftCollections}}
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                <div class="nft-card-2">
                                    <a href="/user/collection/{{ _id }}">
                                        <div class="collection-item-image">
                                            <img src="/layers/{{ ../../user.uuid }}/build/preview.gif" style="width: 100%" alt="{{ name }}">
                                        </div>
                                        <div class="row py-3 nft-collection-name-2">
                                            <h5 class="col-6 ellipsis text-left">
                                                {{ name }}
                                            </h5>
                                            <h5 class="col-6 ellipsis text-right">
                                                {{ symbol }} {{ ../numberToGenerate }}
                                            </h5>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        {{/each}}
                        <div class="col-12 col-md-6 col-lg-4 col-xl-3 h-100">
                            <div class="nft-card-2 p-3 h-100 d-flex flex-column justify-content-center">
                                <div class="folder-plus-container">
                                    <div class="folder" onclick="openFolderBrowser()">
                                        <div class="back"></div>
                                        <div class="cover"></div>
                                        <div class="paper"></div>
                                        <div class="paper"></div>
                                        <div class="paper"></div>
                                    </div>
                                    <img onclick="openFolderBrowser()" src="/img/plus-sign.png" alt="">
                                </div>
                                <input type="file" name="layersFolder" id="layersFolder" onchange="layersFolderUploaded(this)" class="d-none" data-multiple-caption="{count} files selected" webkitdirectory multiple />
                                <h5 class="mt-4">Create another NFT collection for this project</h5>
                            </div>
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>
</section>

<section id="home" class="hero-section">
    <div class="container">
        <div class="col-12 col-lg-10 p-3 mx-auto text-center big-white-modal d-flex flex-column justify-content-center align-items-center">
            <h2>Welcome to your personal area</h2>
            <h4>
                Here you can manage your projects and your NFTs collections.
            </h4>

            <div class="my-projects row w-100 mt-5">
                <h2 class="mb-5">My projects</h2>
                {{#each user.projects}}
                    <h3 class="mb-3">{{ name }}</h3>
                    <div class="row project-container align-items-center">
                        {{#each nftCollections}}
                            <div class="col-12 col-md-6 col-lg-4 col-xl-3">
                                <div class="nft-card">
                                    <a href="/user/collection/{{ _id }}">
                                        <div class="collection-item-image">
                                            <img src="/layers/{{ ../../user.uuid }}/build/preview.gif" style="width: 100%" alt="{{ name }}">
                                        </div>
                                        <div class="p-3 nft-collection-name">
                                            <h5 class="ellipsis">
                                                {{ name }}
                                            </h5>
                                        </div>
                                    </a>
                                </div>
                            </div>
                        {{/each}}
                        <div class="col-12 col-md-6 col-lg-4 col-xl-3 h-100">
                            <div class="nft-card p-3 h-100 d-flex flex-column justify-content-center">
                                <div class="folder-plus-container">
                                    <div class="folder" onclick="openFolderBrowser()">
                                        <div class="back"></div>
                                        <div class="cover"></div>
                                        <div class="paper"></div>
                                        <div class="paper"></div>
                                        <div class="paper"></div>
                                    </div>
                                    <img onclick="openFolderBrowser()" src="/img/plus-sign.png" alt="">
                                </div>
                                <input type="file" name="layersFolder" id="layersFolder" onchange="layersFolderUploaded(this)" class="d-none" data-multiple-caption="{count} files selected" webkitdirectory multiple />
                                <h5 class="mt-4">Create another NFT collection for this project</h5>
                            </div>
                        </div>
                    </div>
                {{/each}}
            </div>
        </div>
    </div>
</section>

<script src="//cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script>
    function openFolderBrowser() {
        const layersFolder = document.getElementById('layersFolder');
        layersFolder.click();
    }

    function layersFolderUploaded(input) {

        let userUuid = localStorage.getItem('userUuid');
        if (!userUuid) {
            userUuid = Math.random().toString(36).substring(7);
        }
        localStorage.setItem('userUuid', userUuid);

        let formData = new FormData();
        for (const file of input.files) {
            let folderStructure = file.webkitRelativePath.split('/');
            folderStructure.shift();
            folderStructure = folderStructure.join('/');
            // TODO check error when upload a folder in Safari
            formData.append(`layersFolder-${userUuid}`, file);
        }
        formData.append(`userUuid`, userUuid);

        const options = {
            method: 'POST',
            body: formData,
        };

        fetch('/nft-creation/post-layers-folder', options)
                .then(response => response.json())
                .catch(error => console.error('Error:', error))
                .then(response => {
                    console.log(response)
                    if (response && response.success === false) {
                        localStorage.removeItem('userUuid');
                        return errorMessage(response.message);
                    }

                    window.location.href = response.redirectTo;

                });
    }

    function errorMessage(message) {
        return Swal.fire({
            width: 300,
            position: 'bottom-end',
            icon: 'error',
            title: 'Oops...',
            text: message,
        })
    }

</script>